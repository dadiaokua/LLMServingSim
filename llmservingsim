#!/bin/bash

# LLMServingSim ä¸»å¯åŠ¨è„šæœ¬
# ç»Ÿä¸€å…¥å£ï¼Œè°ƒç”¨å„ç§å·¥å…·å’ŒåŠŸèƒ½

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

show_help() {
    echo "ğŸš€ LLMServingSim - LLMæ¨ç†æœåŠ¡ä»¿çœŸå™¨"
    echo "=================================="
    echo ""
    echo "ç”¨æ³•: ./llmservingsim <command> [options]"
    echo ""
    echo "ğŸ“‹ å¯ç”¨å‘½ä»¤:"
    echo ""
    echo "ğŸ–¥ï¸  æœåŠ¡å™¨å‘½ä»¤:"
    echo "  server          å¯åŠ¨OpenAIå…¼å®¹APIæœåŠ¡å™¨"
    echo "  server-idle     å¯åŠ¨ç©ºé—²æ¨¡å¼æœåŠ¡å™¨ï¼ˆä¸ç”Ÿæˆæµé‡ï¼‰"
    echo "  server-simple   å¯åŠ¨ç®€åŒ–æ¨¡å¼æœåŠ¡å™¨ï¼ˆç»•è¿‡ASTRA-Simï¼‰"
    echo ""
    echo "ğŸ”§ å·¥å…·å‘½ä»¤:"
    echo "  setup-perf      ç”Ÿæˆæ‰€æœ‰ç¡¬ä»¶çš„æ€§èƒ½æ¨¡å‹æ–‡ä»¶"
    echo "  extend-models   ä¸ºç°æœ‰ç¡¬ä»¶æ·»åŠ æ–°æ¨¡å‹æ”¯æŒ"
    echo "  list-models     åˆ—å‡ºæ”¯æŒçš„æ¨¡å‹å’Œç¡¬ä»¶"
    echo ""
    echo "ğŸ§ª æµ‹è¯•å‘½ä»¤:"
    echo "  test-api        æµ‹è¯•OpenAIå…¼å®¹API"
    echo "  test-http       æµ‹è¯•HTTPæ¥å£"
    echo "  demo-curl       æ˜¾ç¤ºcurlä½¿ç”¨ç¤ºä¾‹"
    echo ""
    echo "ğŸ“Š ä»¿çœŸå‘½ä»¤:"
    echo "  simulate        è¿è¡Œæ ‡å‡†ä»¿çœŸ"
    echo "  benchmark       è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•"
    echo ""
    echo "ğŸ“– å¸®åŠ©å‘½ä»¤:"
    echo "  help            æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo "  version         æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo ""
    echo "ğŸ’¡ ç¤ºä¾‹:"
    echo "  ./llmservingsim server --model qwen/Qwen3-8B --hardware A100"
    echo "  ./llmservingsim server-simple --port 8080"
    echo "  ./llmservingsim test-api http://localhost:8000"
    echo "  ./llmservingsim setup-perf"
    echo ""
    echo "ğŸ“ å·¥å…·æ–‡ä»¶ä½ç½®:"
    echo "  tools/scripts/     - å¯åŠ¨è„šæœ¬"
    echo "  tools/perf_models/ - æ€§èƒ½æ¨¡å‹å·¥å…·"
    echo "  tools/tests/       - æµ‹è¯•å·¥å…·"
}

case "${1:-help}" in
    "server")
        shift
        echo "ğŸš€ å¯åŠ¨OpenAIå…¼å®¹APIæœåŠ¡å™¨..."
        exec tools/scripts/run_openai_server.sh "$@"
        ;;
    
    "server-idle")
        shift
        echo "ğŸš€ å¯åŠ¨ç©ºé—²æ¨¡å¼æœåŠ¡å™¨..."
        exec tools/scripts/run_idle.sh "$@"
        ;;
    
    "server-simple")
        shift
        echo "ğŸš€ å¯åŠ¨ç®€åŒ–æ¨¡å¼æœåŠ¡å™¨ï¼ˆç»•è¿‡ASTRA-Simï¼‰..."
        exec tools/scripts/run_simple_server.sh "$@"
        ;;
    
    "setup-perf")
        echo "ğŸ”§ ç”Ÿæˆæ€§èƒ½æ¨¡å‹æ–‡ä»¶..."
        python3 tools/perf_models/generate_perf_models.py
        ;;
    
    "extend-models")
        echo "ğŸ”§ æ‰©å±•æ¨¡å‹æ”¯æŒ..."
        python3 tools/perf_models/extend_perf_models.py
        ;;
    
    "list-models")
        echo "ğŸ“‹ æ”¯æŒçš„æ¨¡å‹å’Œç¡¬ä»¶:"
        echo ""
        echo "ğŸ¤– æ¨¡å‹:"
        find model_configs -name "*.json" | sed 's|model_configs/||' | sed 's|\.json||' | sort | sed 's/^/  - /'
        echo ""
        echo "ğŸ–¥ï¸ ç¡¬ä»¶:"
        find perf_model -name "*.csv" | sed 's|perf_model/||' | sed 's|\.csv||' | sort | sed 's/^/  - /'
        ;;
    
    "test-api")
        shift
        echo "ğŸ§ª æµ‹è¯•OpenAIå…¼å®¹API..."
        python3 tools/tests/test_openai_api.py "$@"
        ;;
    
    "test-http")
        shift
        echo "ğŸ§ª æµ‹è¯•HTTPæ¥å£..."
        python3 tools/tests/test_http_api.py "$@"
        ;;
    
    "demo-curl")
        echo "ğŸ’¡ æ˜¾ç¤ºcurlä½¿ç”¨ç¤ºä¾‹..."
        tools/scripts/demo_curl_response.sh
        ;;
    
    "simulate")
        shift
        echo "ğŸ“Š è¿è¡Œä»¿çœŸ..."
        python3 main.py "$@"
        ;;
    
    "benchmark")
        shift
        echo "ğŸ“Š è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        echo "åŠŸèƒ½å¼€å‘ä¸­..."
        ;;
    
    "version")
        echo "LLMServingSim v0.2.1"
        echo "æ”¯æŒOpenAIå…¼å®¹APIçš„LLMæ¨ç†æœåŠ¡ä»¿çœŸå™¨"
        ;;
    
    "help"|"-h"|"--help")
        show_help
        ;;
    
    *)
        echo "âŒ æœªçŸ¥å‘½ä»¤: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
